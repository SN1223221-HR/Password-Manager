<script>
  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
  function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabName + 'Tab').classList.add('active');
    event.currentTarget.classList.add('active');
  }

  // åˆæœŸãƒ­ãƒ¼ãƒ‰ï¼šæ¤œç´¢å€™è£œå–å¾—
  window.onload = () => {
    google.script.run.withSuccessHandler(names => {
      const list = document.getElementById('nameList');
      names.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        list.appendChild(opt);
      });
    }).getCredentialNames();
  };

  // æ¤œç´¢
  function search() {
    const name = document.getElementById('nameInput').value;
    google.script.run.withSuccessHandler(data => {
      const area = document.getElementById('resultArea');
      area.style.display = 'block';
      if (!data) {
        area.innerHTML = '<p style="color:red">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
        return;
      }
      area.innerHTML = `
        ${renderRow('ID', data.id)}
        ${renderRow('PASS', 'â—â—â—â—â—â—', data.pass)}
        ${renderRow('URL', data.url)}
        ${renderRow('MEMO', data.memo || '-')}
      `;
    }).getCredentialByName(name);
  }

  function renderRow(label, displayVal, realVal = null) {
    const valToCopy = realVal || displayVal;
    return `
      <div class="res-row">
        <div class="res-label">${label}</div>
        <div class="res-value" id="val-${label}">${displayVal}</div>
        <button class="copy-btn" onclick="copyToClip('${valToCopy.replace(/'/g, "\\'")}')">Copy</button>
        ${realVal ? `<button class="copy-btn" style="right:45px" onclick="togglePlain('${realVal}', 'val-${label}')">ğŸ‘</button>` : ''}
      </div>`;
  }

  function copyToClip(text) {
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  }

  function togglePlain(realPass, id) {
    const el = document.getElementById(id);
    el.innerText = el.innerText === 'â—â—â—â—â—â—' ? realPass : 'â—â—â—â—â—â—';
  }

  // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  function handleImport() {
    const fileInput = document.getElementById('csvFile');
    const status = document.getElementById('importStatus');
    if (fileInput.files.length === 0) return alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');

    const file = fileInput.files[0];
    const reader = new FileReader();
    status.innerText = 'è§£æä¸­...';

    reader.onload = function(e) {
      google.script.run.withSuccessHandler(msg => {
        status.innerText = msg;
        alert(msg);
      }).importPasswordsFromCsv(e.target.result);
    };
    reader.readAsText(file);
  }
</script>
